<!DOCTYPE html>
<html class="x-admin-sm">
<head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.2</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="/static/admin/index/css/font.css">
    <link rel="stylesheet" href="/static/admin/index/css/xadmin.css">


    <!--<link rel="stylesheet" href="/static/public/layui/treetable-lay/css/demo.css">-->
    <script src="/static/public/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/public/js/jquery.min.js"></script>


    <script type="text/javascript" src="/static/admin/index/js/xadmin.js"></script>
    <!--<script type="text/javascript" src="/static/public/js/jquery.min.js"></script>-->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body style="background-color: #fff">
<div class="x-nav">
    <span class="layui-breadcrumb">
      <a href="">首页</a>
      <a href="">公共管理</a>
      <a><cite>部门管理</cite></a>
    </span>
    <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
       onclick="location.reload()" title="刷新">
        <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i></a>
</div>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <!--添加部门：begin-->
                <div class="" style="border-bottom: 4px solid #f1f1f1;padding: 10px 15px;">

                    <form class="layui-form layui-col-space5" id="addForm">

                        <label for="tree">所属部门</label>
                        <!--<a class="layui-btn layui-btn-primary"
                           href="https://wujiawei0926.gitee.io/treeselect/docs/doc.html">查看文档</a>-->
                        <div class="layui-inline">
                            <input type="hidden" id="parentDepartment" name="parentDepartment">
                            <input type="text" id="tree" lay-filter="tree" class="layui-input">
                        </div>


                        <label for="addDepartmentName">新增部门名称</label>
                        <div class="layui-inline">
                            <input type="text" name="addDepartmentName" id="addDepartmentName" required
                                   lay-verify="addDepartmentName" placeholder="请输入部门名称"
                                   autocomplete="off" class="layui-input">
                        </div>

                        <div class="layui-input-inline">
                            <button class="layui-btn" lay-submit lay-filter="addForm">添加部门</button>
                            <a id="resetAdd" class="layui-btn layui-btn-primary">重置</a>
                        </div>
                    </form>
                </div>

                <!--添加部门：end-->
                <!--部门搜索功能：begin-->
                <div class="" style="padding: 10px 15px;">
                    <form class="layui-form layui-col-space5" id="searchForm">

                        <label for="searchDepartmentName">部门名称</label>
                        <!--<a class="layui-btn layui-btn-primary"
                           href="https://wujiawei0926.gitee.io/treeselect/docs/doc.html">查看文档</a>-->
                        <div class="layui-inline">
                            <input type="text" name="searchDepartmentName" id="searchDepartmentName"
                                   placeholder="请输入部门名称"
                                   autocomplete="off"
                                   class="layui-input">
                        </div>

                        <label for="searchDepartmentNo">部门编号</label>
                        <div class="layui-inline">
                            <input type="text" name="searchDepartmentNo" id="searchDepartmentNo" placeholder="请输入部门编号"
                                   autocomplete="off"
                                   class="layui-input">
                        </div>

                        <div class="layui-inline" style="width: 50px">
                            <input type="text" name="searchMemberMin" id="searchMemberMin"
                                   placeholder="" autocomplete="off"
                                   class="layui-input">
                        </div>
                        <label for="searchMemberMax"><span class="iconfont">&#xe697;＝</span>部门人数<span
                                class="iconfont">&#xe697;</span></label>
                        <div class="layui-inline" style="width: 50px">
                            <input type="text" name="searchMemberMax" id="searchMemberMax"
                                   placeholder="" autocomplete="off"
                                   class="layui-input">
                        </div>

                        <div class="layui-inline">
                            <input class="layui-input" autocomplete="off" placeholder="请输入开始时间" name="start" id="start">
                        </div>

                        <span class="iconfont">&#xe697;</span>
                        <div class="layui-inline" style="width: 66px;">
                            <input type="checkbox" checked="" name="open" id="timeType" lay-skin="switch"
                                   lay-filter="switchTest"
                                   lay-text="添加|更新">
                        </div>
                        <span class="iconfont">&#xe697;</span>
                        <div class="layui-inline">
                            <input class="layui-input" autocomplete="off" placeholder="请输入截至时间" name="end" id="end">
                        </div>
                        <div class="layui-inline layui-show-xs-block">
                            <a class="layui-btn" lay-submit="" lay-filter="sreach" title="搜索" id="search"><i
                                    class="layui-icon">&#xe615;</i></a>
                        </div>
                        <div class="layui-inline layui-show-xs-block">
                            <a class="layui-btn layui-btn-primary" lay-submit="" lay-filter="sreach" title="重置"
                               id="resetSearch"><i
                                    class="iconfont">&#xe6aa;</i></a>
                        </div>
                        <div class="layui-inline layui-show-xs-block">
                            <span>（不保留树型结构显示）</span>
                        </div>
                    </form>
                </div>
                <!--部门搜索功能：end-->

                <!--表头操作：begin-->
                <script type="text/html" id="toolbarDemo">
                    <div class="layui-btn-container">
                        <div class="layui-btn-container" style="display: inline-block;">
                            <button id="btnRefresh" lay-event="btnRefresh"
                                    class="layui-btn layui-btn-sm layui-btn-primary">
                                <i class="layui-icon">&#xe669;</i>刷新
                            </button>
                        </div>
                        <div class="layui-btn-container" style="display: inline-block;">
                            <button lay-event="btnExpandAll" class="layui-btn layui-btn-sm layui-btn-primary">
                                <i class="layui-icon">&#xe668;</i>展开全部
                            </button>
                            <button lay-event="btnFoldAll" class="layui-btn layui-btn-sm layui-btn-primary">
                                <i class="layui-icon">&#xe66b;</i>折叠全部
                            </button>

                        </div>


                        <button class="layui-btn layui-btn-sm" style="padding: 0">
                            <input class="layui-input" id="edtSearch" value="" placeholder="输入关键字搜索"
                                   style="display: inline-block;width: 100%;height: 30px;line-height: 30px;padding: 0px 5px;margin: 0 -5px"/>
                        </button>
                        <div class="layui-btn-container" style="display: inline-block;">
                            <button lay-event="btnSearch" class="layui-btn">
                                <i class="layui-icon">&#xe615;</i>搜索
                            </button>
                            <button lay-event="btnClearSearch" class="layui-btn layui-btn-sm layui-btn-primary">
                                <i class="layui-icon">&#x1006;</i>清除搜索
                            </button>
                        </div>
                    </div>
                </script>
                <!--表头操作：end-->

                <!--table:begin-->

                <table id="departmentTreeTb"></table>

                <!-- 表格操作列 -->
                <script type="text/html" id="tbBar">
                    {{#if(parseInt(d.isLeaf)<2){}}
                    <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
                    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
                    {{#}else{}}
                    {{#}}}
                </script>
                <!--table:end-->
                <!-- 表格图标 -->
                <script type="text/html" id="iconTpl">
                    {{#  switch(d.isLeaf){
                    case '0':
                    }}
                    <p><i class="layui-icon layui-icon-menu-fill"></i></p>
                    {{#  break;
                    case '1':
                    }}
                    <p><i class="layui-icon layui-icon-flag"></i></p>
                    {{#  break;
                    case '2':
                    }}
                    <p><i class="layui-icon layui-icon-username"></i></p>
                    {{#  break;} }}
                </script>
                <!--table:end-->

            </div>
        </div>
    </div>
</div>

<!--<script src="/static/public/layui/layui.js"></script>-->
<!--头部的xadmin.js已经包含layui.js，重复引入会报错-->
<!--导入layui第三方插件-->
<script src="/static/public/layui/import.js"></script>

<script>


    //定义统一资源路径
    var apiUrl = '/common/department/';

    //setInterval(getData, 5*1000); //每隔5分钟刷新数据表


    /*=======================显示数据：begin========================*/
    layui.define(['layer', 'treeTable', 'tree', 'treeSelect', 'form', 'laydate'], function (exports) {
        var $ = layui.jquery,
            layer = layui.layer,
            treeTable = layui.treeTable,
            form = layui.form,
            laydate = layui.laydate,
            treeSelect = layui.treeSelect;
        //创建一个对象
        let condition = new Object(); //查询条件
        $('body').removeClass('layui-hide');//移除有hide属性的类

        /*===========添加表单监听：begin============*/

        //部门树型选择器
        treeSelect.render({
            // 选择器
            elem: '#tree',
            // 数据
            data: apiUrl + 'getDepartmentTree',
            // 请求头
            headers: {},
            // 异步加载方式：get/post，默认get
            type: 'get',
            // 占位符
            placeholder: '请选择所属部门',
            // 是否开启搜索功能：true/false，默认false
            search: true,
            // 一些可定制的样式
            style: {
                folder: {
                    enable: false
                },
                line: {
                    enable: true
                }
            },
            // 点击回调
            click: function (d) {
                console.log(d.current); // 得到点击节点的treeObj对象
                console.log(d.current.id); // 得到点击节点的treeObj对象
                $('#parentDepartment').val(d.current.id);
            },
            // 加载完成后的回调函数
            success: function (d) {
                /*console.log(d);
                //选中节点，根据id筛选
                treeSelect.checkNode('tree', 3);

                console.log($('#tree').val());

                //获取zTree对象，可以调用zTree方法
                var treeObj = treeSelect.zTree('tree');
                console.log(treeObj);*/
                //刷新树结构
                treeSelect.refresh('tree');
            }
        });
        //重置
        layui.$('#resetAdd').on('click', function () {
            $('#addForm')[0].reset();
            $('#parentDepartment').val('');
        });

        //自定义验证规则
        form.verify({
            addDepartmentName: function (value) {
                if (value.length > 30 || value.length < 1) {
                    return '部门名称为1~30个字符';
                }
            },
        });
        //提交
        form.on('submit(addForm)', function (data) {
            var field = data.field;//添加表单字段
            //var module=$('#module option:selected').text(); //获取选中的模块名称（非value值）
            //field['module']=module;　//替换表单字段中module的值为text值
            console.log(field);
            $.ajax({
                url: apiUrl + 'add',
                type: 'post',
                dataType: 'json',
                data: field,
                success: function (data) {
                    if (data.code == '000') {
                        refresh();
                        layer.msg(data.message);
                    } else {
                        layer.msg(data.message, {
                            anim: 6
                        })
                    }
                },
                error: function (data) {
                    layer.msg(data.responseText, {
                        anim: 6
                    })
                }
            })
            return false; //不刷新页面
        });

        /*============添加表单监听：end==============*/


        /*============渲染显示表格：begin=============*/
        var insTb = treeTable.render({
            elem: '#departmentTreeTb',
            //url: apiUrl + 'getData',
            toolbar: '#toolbarDemo', //开启头部工具栏，并为其绑定左侧模板
            height: 'full-200',

            where: {
                departmentName: '',
                departmentNo: '',
                memberMin: '',
                memberMax: '',
                timeType: '',
                start: '',
                end: '',
            },       // 请求参数
            tree: {
                iconIndex: 1,
                isPidData: true,
                idName: 'id',
                pidName: 'parentId'
            },
            cols: [
                [
                    {type: 'numbers', width: 50},
                    {
                        field: 'departmentName',
                        title: '部门名称',
                        minWidth: 165,
                        //edit: 'text'//开启行内编辑，监听函数是：treeTable.on('edit(departmentTreeTb)', function (obj))
                    },

                    {field: 'departmentNo', title: '部门编号'},
                    {
                        //这种方式可以自定义输出
                        title: '类型图标', align: 'center', hide: false,
                        templet: '#iconTpl'
                    },
                    {field: 'members', title: '部门人数'},
                    {field: 'operator', title: '最近操作人'},

                    {field: 'update_time', title: '更新时间',},
                    {field: 'create_time', title: '创建时间',},


                    {align: 'center', toolbar: '#tbBar', title: '操作', width: 220}
                ]
            ],
            style: 'margin-top:0;',
            //无闪动加载刷新数据
            reqData: function (data, callback) {
                $.get(apiUrl + 'getData', condition, function (res) {
                    callback(res.data);
                });
            },
        });
        window.setInterval(getData, 1 * 6 * 1000);  //每分钟重载数据

        // 头部工具栏点击事件
        treeTable.on('toolbar(departmentTreeTb)', function (obj) {
            switch (obj.event) {
                // 重载
                case 'btnRefresh':
                    //insTb.reload();
                    insTb.refresh(true); //refresh(loading) loading:是否显示加载层图标
                    break;
                // 全部展开
                case 'btnExpandAll':
                    insTb.expandAll();
                    break;
                // 全部折叠
                case 'btnFoldAll':
                    insTb.foldAll();
                    break;
                // 搜索
                case 'btnSearch':
                    var keywords = $('#edtSearch').val();
                    if (keywords) {
                        insTb.filterData(keywords);
                    } else {
                        insTb.clearFilter();
                    }
                    break;
                // 清除搜索
                case 'btnClearSearch':
                    $('#edtSearch').val('');
                    insTb.clearFilter();
                    break;


            }
        });
        // 监听行双击事件
        treeTable.on('rowDouble(departmentTreeTb)', function (obj) {
            console.log(obj.tr) //得到当前行元素对象
            console.log(obj.data) //得到当前行数据
            // obj.del(); // 删除当前行
            // obj.update(fields) // 修改当前行数据
            var data = obj.data;
            parent.addTab(data.departmentName, '/common/position/index?departmentId=' + data.id);
        });
        // 表格体工具列点击事件
        treeTable.on('tool(departmentTreeTb)', function (obj) {
            var event = obj.event;
            var data = obj.data;
            switch (event) {
                case 'detail':
                    parent.addTab(data.departmentName+'(部门)', '/common/position/index?departmentId=' + data.id);
                    //obj.update({departmentName: '新的名称'});
                    break;
                case 'del':
                    layer.msg('确定删除数据吗(' + data.departmentName + ')？', {
                        //icon: 1,
                        time: 5000,
                        closeBtn: true,
                        btn: ['yes', 'no'],
                        yes: function (index) {
                            //do something
                            layer.close(index);
                            $.ajax({
                                url: apiUrl + 'delete',
                                type: 'post',
                                dataType: 'json',
                                data: {'departmentId': data.id},
                                success: function (data) {
                                    if (data.code == '000') {
                                        layer.msg(data.message);
                                        obj.del();
                                    } else {
                                        layer.msg(data.message, {
                                            anim: 6
                                        })
                                    }
                                },
                                error: function (data) {
                                    layer.msg(data.responseText, {
                                        anim: 6
                                    })
                                }
                            })

                        }
                    });
                    break;
                case 'edit':
                    xadmin.open('编辑', apiUrl + 'edit?id=' + data.id + '&parentId=' + data.parentId + '&departmentName=' + data.departmentName, 460, 230)
                    //layer.msg('修改成功');
                    //obj.update({departmentName: '新的名称'});
                    break;

            }
        });

        //更新数据==================================begin
        function getData(loading = false) {
            //loading:是否显示加载层图标
            var search = new Object({
                departmentName: $("#searchDepartmentName").val(),
                departmentNo: $("#searchDepartmentNo").val(),
                memberMin: $("#searchMemberMin").val(),
                memberMax: $("#searchMemberMax").val(),
                timeType: $('#timeType').is(':checked') ? 'create_time' : 'update_time',
                start: $("#start").val(),
                end: $("#end").val(),
            });
            $.extend(condition, search); //合并对象
            insTb.refresh(loading);  // 刷新数据(数据模式)
        }

        //向外部暴露的刷新方法
        exports('exportGetData', function () {
            insTb.refresh();  // 刷新一级数据(数据模式)
        });
        //更新数据==================================end

        //查询刷新数据===============================begin
        //刷新，重置搜索条件
        function refresh() {
            $("input[type=file]").val("");//清空文件输入框
            $('#searchForm')[0].reset();
            getData(true); //重新获取数据
            //刷新部门树型选择器
            treeSelect.refresh('tree');
        }

        //监听搜索按钮
        $(function () {
            //搜索按钮
            $('#search').on("click", function () {
                getData(true);　//重新获取数据
            });
            //重置按钮
            $("#resetSearch").on("click", function () {
                refresh(true);//刷新，重置搜索条件
            });

        });
        //查询刷新数据===============================end


        /*============渲染显示表格：end=============*/

        //执行一个laydate实例
        laydate.render({
            elem: '#start', //指定元素
            type: 'datetime',
        });

        //执行一个laydate实例
        laydate.render({
            elem: '#end', //指定元素
            type: 'datetime'
        });


    });
    /*==============================显示数据：end===============================*/
    //获取数据
    //获取更新数据(编辑页面调用)
    function getData() {
        layui.exportGetData();
    }


    /*tips层*/
    $('#addDepartmentName').focus(function () {
        layer.tips('中文或中文加数字组合', '#addDepartmentName', {
            tips: 1,
            time: 3000
        });
    })

</script>

</body>
</html>